# Go GORM å¼€å‘é¿å‘æŒ‡å— (2025-12-11)

æœ¬æ–‡æ€»ç»“äº†åœ¨ Go + Gin + GORM å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–äº†å…³è”æŸ¥è¯¢ã€è¡¨åæ˜ å°„ã€Tag å®šä¹‰ç­‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚

## 1. æ•°æ®åº“è¡¨åä¸æ¨¡å‹æ˜ å°„

### ğŸ’£ é™·é˜±ï¼šå•å¤æ•°ä¸ä¸€è‡´å¯¼è‡´ "Table doesn't exist"
*   **ç°è±¡**ï¼šä»£ç ä¸­æ¨¡å‹åä¸º `StudentCourse`ï¼ˆå•æ•°ï¼‰ï¼Œä½†æ•°æ®åº“å®é™…è¡¨åä¸º `student_courses`ï¼ˆå¤æ•°ï¼‰ã€‚GORM é»˜è®¤ä½¿ç”¨å¤æ•°ï¼Œä½†å¦‚æœä»£ç ä¸­ç¡¬ç¼–ç äº† `Table("student_course")` æˆ– `TableName()` è¿”å›å•æ•°ï¼Œå°±ä¼šå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚
*   **é”™è¯¯ç¤ºä¾‹**ï¼š
    ```go
    // Model å®šä¹‰
    func (s *StudentCourse) TableName() string { return "student_course" } // âŒ å¼ºè¡ŒæŒ‡å®šå•æ•°
    // Controller è°ƒç”¨
    model.DB.Table("student_course")... // âŒ ç¡¬ç¼–ç å•æ•°
    ```
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼š
    1.  **éµå¾ªè§„èŒƒ**ï¼šå°½é‡è®©æ•°æ®åº“è¡¨åå’Œ GORM é»˜è®¤è§„åˆ™ï¼ˆè›‡å½¢å¤æ•°ï¼‰ä¿æŒä¸€è‡´ã€‚
    2.  **ç»Ÿä¸€ä¿®æ”¹**ï¼šå¦‚æœæ•°æ®åº“æ˜¯å¤æ•°ï¼Œç¡®ä¿ `TableName()` è¿”å›å¤æ•°ï¼Œä¸”ä»£ç ä¸­ `Joins` ç­‰åŸç”Ÿ SQL éƒ¨åˆ†ä¹Ÿä½¿ç”¨å¤æ•°è¡¨åã€‚

## 2. å…³è”æŸ¥è¯¢ (Joins vs Preload)

### ğŸ’£ é™·é˜± 1ï¼šPreload ä¸­ä½¿ç”¨ Where è¿‡æ»¤å…³è”è¡¨å­—æ®µ
*   **ç°è±¡**ï¼š`Error 1054: Unknown column 'courses.name' in 'where clause'`
*   **åŸå› **ï¼š`Preload` æ˜¯åˆ†æ­¥æŸ¥è¯¢ï¼ˆå…ˆæŸ¥ä¸»è¡¨ï¼Œå†æŸ¥å­è¡¨ï¼‰ã€‚ä¸»æŸ¥è¯¢ SQL æ‰§è¡Œæ—¶ï¼Œå­è¡¨è¿˜æ²¡æœ‰ Join è¿›æ¥ï¼Œæ‰€ä»¥æ— æ³•è¯†åˆ«å­è¡¨å­—æ®µã€‚
*   **é”™è¯¯ç¤ºä¾‹**ï¼š
    ```go
    // è¯•å›¾æŸ¥â€œé€‰äº† Python è¯¾çš„å­¦ç”Ÿâ€
    db.Preload("Courses").Where("courses.name = ?", "Python").Find(&students)
    ```
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `Joins` è¿›è¡Œå†…è¿æ¥æŸ¥è¯¢ã€‚
    ```go
    db.Joins("JOIN student_courses ON ...").
       Joins("JOIN courses ON ...").
       Where("courses.name = ?", "Python").
       Find(&students)
    ```

### ğŸ’£ é™·é˜± 2ï¼šPreload æŠ¥ "unsupported relations"
*   **åŸå› **ï¼šGORM æ— æ³•è§£æç»“æ„ä½“ä¸­çš„å…³è” Tagï¼Œé€šå¸¸æ˜¯ Tag è¯­æ³•é”™è¯¯æˆ–é€»è¾‘å†²çªã€‚
*   **é”™è¯¯ç¤ºä¾‹**ï¼š
    ```go
    // å†—ä½™ä¸”å¯èƒ½é”™è¯¯çš„ Tag
    Department Department `gorm:"foreignKey:DeptID;references:DeptID"`
    ```
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼š**ç®€åŒ– Tag**ã€‚é€šå¸¸åªéœ€è¦æŒ‡å®š `foreignKey`ï¼Œè®© GORM è‡ªåŠ¨æ¨æ–­ `references`ï¼ˆé»˜è®¤æ˜¯ä¸»é”®ï¼‰ã€‚
    ```go
    Department Department `gorm:"foreignKey:DeptID"`
    ```

## 3. å­—æ®µåä¸åˆ—å

### ğŸ’£ é™·é˜±ï¼šWhere æŸ¥è¯¢ä¸­ä½¿ç”¨ç»“æ„ä½“å­—æ®µå
*   **ç°è±¡**ï¼š`Error 1054: Unknown column 'EmpName' in 'where clause'`
*   **åŸå› **ï¼šåŸç”Ÿ SQL ç‰‡æ®µï¼ˆ`Where`, `Order`, `Select`ï¼‰å¿…é¡»ä½¿ç”¨**æ•°æ®åº“åˆ—å**ï¼ˆå¦‚ `emp_name`ï¼‰ï¼Œä¸èƒ½ç”¨ç»“æ„ä½“å­—æ®µåï¼ˆå¦‚ `EmpName`ï¼‰ã€‚
*   **é”™è¯¯ç¤ºä¾‹**ï¼š
    ```go
    db.Where("EmpName = ?", "å¼ ä¸‰") // âŒ å­—æ®µå
    ```
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼š
    ```go
    db.Where("emp_name = ?", "å¼ ä¸‰") // âœ… åˆ—å
    ```

## 4. GORM Tag å®šä¹‰è§„èŒƒ

### ğŸ’£ é™·é˜±ï¼šä¸æ ‡å‡†çš„ Tag å†™æ³•
*   **ç°è±¡**ï¼šTag è§£æå¤±æ•ˆï¼Œæˆ–è€…è¡Œä¸ºä¸ç¬¦åˆé¢„æœŸã€‚
*   **å»ºè®®**ï¼š
    *   ä½¿ç”¨å®Œæ•´å†™æ³•ï¼š`gorm:"column:emp_name"` è€Œä¸æ˜¯ `gorm:"emp_name"`ã€‚
    *   æ³¨æ„å¤§å°å†™å’Œç©ºæ ¼ã€‚

## 5. SQL è°ƒè¯•æŠ€å·§

*   **ç¥å™¨**ï¼š`model.DB.Debug()`
*   **ä½œç”¨**ï¼šåœ¨æ‰§è¡ŒæŸ¥è¯¢å‰åŠ ä¸Š `.Debug()`ï¼Œæ§åˆ¶å°ä¼šæ‰“å°å‡º GORM ç”Ÿæˆçš„æœ€ç»ˆ SQL è¯­å¥ã€‚
*   **æ’æŸ¥æµç¨‹**ï¼š
    1.  ä»£ç æŠ¥é”™ã€‚
    2.  åŠ  `.Debug()` å¤ç°ã€‚
    3.  å¤åˆ¶æ§åˆ¶å° SQL åˆ°æ•°æ®åº“å®¢æˆ·ç«¯æ‰§è¡Œã€‚
    4.  æ ¹æ®æ•°æ®åº“æŠ¥é”™ä¿®æ­£ä»£ç ã€‚

## 6. ä¸€å¯¹å¤š/å¤šå¯¹ä¸€å…³è”é…ç½®é™·é˜±

### ğŸ’£ é™·é˜± 1ï¼šæ•°æ®â€œå¼ å† ææˆ´â€
*   **ç°è±¡**ï¼šæŸ¥å‡ºæ¥çš„å…³è”æ•°æ®ä¸å¯¹ï¼ˆæ¯”å¦‚æŸ¥ DeptID=10 çš„å‘˜å·¥ï¼Œç»“æœå¸¦å‡ºæ¥çš„éƒ¨é—¨å´æ˜¯ DeptID=1 çš„ï¼‰ã€‚
*   **åŸå› **ï¼š**Tag å®šä¹‰ä¸å®Œæ•´æˆ–æ­§ä¹‰**ã€‚
    *   å½“ä¸»é”®ä¸æ˜¯æ ‡å‡†çš„ `ID` æ—¶ï¼ˆå¦‚ `DeptID`ï¼‰ï¼ŒGORM çš„è‡ªåŠ¨æ¨æ–­å¯èƒ½ä¼šå¤±æ•ˆï¼Œé»˜è®¤å»åŒ¹é… `ID` å­—æ®µã€‚
    *   æˆ–è€… `foreignKey` å’Œ `references` çš„æŒ‡å‘æ··æ·†ã€‚
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼š
    *   **æ˜¾å¼æŒ‡å®š References**ï¼šæ˜ç¡®å‘Šè¯‰ GORM å¤–é”®å¼•ç”¨çš„æ˜¯å¯¹æ–¹çš„å“ªä¸ªå­—æ®µã€‚
    ```go
    // Employee å±äº Department
    Department Department `gorm:"foreignKey:DeptID;references:DeptID"`
    ```

### ğŸ’£ é™·é˜± 2ï¼šæŠ¥é”™ "invalid field found for struct ... define a valid foreign key"
*   **ç°è±¡**ï¼šç¨‹åºå¯åŠ¨æˆ–æŸ¥è¯¢æ—¶ç›´æ¥ Panic æˆ–æŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°åˆæ³•å¤–é”®ã€‚
*   **åŸå› **ï¼š
    *   **Tag é€»è¾‘å†²çª**ï¼šä¸¤è¾¹éƒ½å®šä¹‰äº† `references` ä¸”æŒ‡å‘ä¸æ˜ã€‚
    *   **å¾ªç¯å¼•ç”¨/è§£ææ­»é”**ï¼šåœ¨åŒå‘å…³è”ä¸­ï¼ŒTag å®šä¹‰è¿‡äºå¤æ‚å¯¼è‡´è§£æå™¨â€œæ™•â€äº†ã€‚
*   **âœ… è§£å†³æ–¹æ¡ˆ**ï¼š
    *   **ç¡®ä¿ä¸»é”® Tag å­˜åœ¨**ï¼šè¢«å¼•ç”¨çš„ç»“æ„ä½“å­—æ®µï¼ˆå¦‚ `Department.DeptID`ï¼‰å¿…é¡»æœ‰ `gorm:"primaryKey"`ã€‚
    *   **ç®€åŒ– Tag**ï¼šé€šå¸¸åªéœ€è¦åœ¨ `Belongs To` ä¸€ä¾§å†™ `foreignKey`ï¼Œå»æ‰ `references`ï¼ˆè®©å®ƒé»˜è®¤æ‰¾ä¸»é”®ï¼‰ã€‚å¦‚æœé»˜è®¤æ‰¾ä¸å¯¹ï¼Œå†åŠ  `references`ã€‚
    *   **æ£€æŸ¥æ‹¼å†™**ï¼šTag ä¸­çš„å­—æ®µåå¿…é¡»ä¸¥æ ¼åŒ¹é… Go ç»“æ„ä½“å­—æ®µåï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ã€‚

## 7.Unknown column 'course_name' in 'where clause'

###  é”™è¯¯åŸå› è§£æUnknown column 'course_name' in 'where clause'
ä½ è¿™è¡Œä»£ç çš„æ„å›¾æ˜¯ï¼š â€œæŸ¥è¯¢é€‰ä¿®äº†â€˜è®¡ç®—æœºç§‘å­¦å¯¼è®ºâ€™çš„æ‰€æœ‰å­¦ç”Ÿâ€ ã€‚

```go
// ä»£ç 
func (s *CourseController) GetStudentName(c *gin.Context) {
	var StudentList []student.Student
	model.DB.Debug().Preload("Courses").Where("course_name = ?", "è®¡ç®—æœºç§‘å­¦å¯¼è®º").Order("student_id Desc").Find(&StudentList)
	c.JSON(200, gin.H{
		"message": "æŸ¥è¯¢æˆåŠŸ",
		"result":  StudentList,
	})
}


1. GORM çš„æ‰§è¡Œé¡ºåº ï¼š Find(&StudentList) å†³å®šäº†è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹ ä¸»è¡¨ ( students ) çš„æŸ¥è¯¢ã€‚
2. SQL ç”Ÿæˆ ï¼šGORM ä¼šç”Ÿæˆç±»ä¼¼ SELECT * FROM students WHERE course_name = 'è®¡ç®—æœºç§‘å­¦å¯¼è®º' çš„ SQLã€‚
3. æŠ¥é”™ ï¼š students è¡¨é‡Œæ ¹æœ¬æ²¡æœ‰ course_name å­—æ®µï¼è¿™ä¸ªå­—æ®µåœ¨ courses è¡¨é‡Œã€‚
å…³é”®ç‚¹ ï¼š Preload åªæ˜¯å‘Šè¯‰ GORM â€œæŸ¥å®Œå­¦ç”Ÿåï¼Œé¡ºä¾¿å»æŸ¥ä¸€ä¸‹ä»–ä»¬çš„è¯¾â€ï¼Œå®ƒ ä¸ä¼š æŠŠè¯¾ç¨‹è¡¨ Join è¿›ä¸»æŸ¥è¯¢é‡Œã€‚æ‰€ä»¥åœ¨ä¸»æŸ¥è¯¢çš„ Where é‡Œä¸èƒ½ç”¨è¯¾ç¨‹è¡¨çš„å­—æ®µã€‚
```

