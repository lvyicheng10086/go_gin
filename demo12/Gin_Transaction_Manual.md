# Gin + GORM äº‹åŠ¡å¤„ç†å®æˆ˜æ‰‹å†Œ

æœ¬æ–‡æ¡£åŸºäº `demo12` é¡¹ç›®å®æˆ˜ç»éªŒï¼Œæ€»ç»“äº†åœ¨ Gin æ¡†æ¶ä¸­é…åˆ GORM è¿›è¡Œæ•°æ®åº“äº‹åŠ¡æ“ä½œçš„æ ‡å‡†æµç¨‹ä¸æœ€ä½³å®è·µã€‚é‡ç‚¹æ¶µç›–äº†äº‹åŠ¡çš„å¼€å¯ã€å›æ»šã€æäº¤ä»¥åŠé«˜å¹¶å‘åœºæ™¯ä¸‹çš„åŸå­æ›´æ–°æŠ€å·§ã€‚

## 1. æ ¸å¿ƒæ¦‚å¿µ

äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯æ•°æ®åº“æ“ä½œçš„åŸºæœ¬å•å…ƒï¼Œå…·æœ‰ ACID ç‰¹æ€§ï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰ã€‚åœ¨è½¬è´¦ã€è®¢å•æ‰£å‡ç­‰åœºæ™¯ä¸­ï¼Œäº‹åŠ¡ç¡®ä¿äº†â€œè¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åšâ€ã€‚

---

## 2. æ ‡å‡†æ“ä½œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå¼€å¯äº‹åŠ¡
ä½¿ç”¨ `model.DB.Begin()` è·å–ä¸€ä¸ªäº‹åŠ¡å¯¹è±¡ `tx`ã€‚
> âš ï¸ **æ³¨æ„**ï¼šä¹‹åçš„æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨ `tx` è€Œä¸æ˜¯å…¨å±€çš„ `model.DB`ï¼Œå¦åˆ™æ“ä½œå°†ä¸åœ¨äº‹åŠ¡å†…ã€‚

```go
tx := model.DB.Begin()
```

### ç¬¬äºŒæ­¥ï¼šè®¾ç½®å…œåº•å›æ»š (Panic Protection)
ä¸ºäº†é˜²æ­¢ç¨‹åºåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿ Panic å¯¼è‡´äº‹åŠ¡æœªå…³é—­ï¼ˆé€ æˆæ­»é”ï¼‰ï¼Œå¿…é¡»åœ¨ defer ä¸­è¿›è¡Œ recover å’Œå›æ»šã€‚

```go
defer func() {
    if r := recover(); r != nil {
        tx.Rollback()
        // è®°å½•æ—¥å¿—æˆ–è¿”å›é”™è¯¯
        fmt.Println("ç³»ç»Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡å›æ»š:", r)
    }
}()
```

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œä¸šåŠ¡é€»è¾‘ & é”™è¯¯å¤„ç†
æ‰§è¡Œæ¯ä¸€æ­¥æ•°æ®åº“æ“ä½œåï¼Œå¿…é¡»æ£€æŸ¥ `err`ã€‚ä¸€æ—¦æŠ¥é”™ï¼Œç«‹å³å›æ»šå¹¶è¿”å›ã€‚

```go
// ç¤ºä¾‹ï¼šæŸ¥è¯¢ç”¨æˆ·
var user model.User
if err := tx.Where("name = ?", "å¼ ä¸‰").First(&user).Error; err != nil {
    tx.Rollback() // âŒ å¤±è´¥å›æ»š
    return
}
```

### ç¬¬å››æ­¥ï¼šæäº¤äº‹åŠ¡ (Commit)
æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸåï¼Œ**å¿…é¡»**æ˜¾å¼è°ƒç”¨ `Commit`ã€‚å¦‚æœä¸æäº¤ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»šï¼Œæ•°æ®ä¸ä¼šå†™å…¥æ•°æ®åº“ã€‚

```go
tx.Commit() // âœ… æˆåŠŸæäº¤
```

---

## 3. é«˜å¹¶å‘é¿å‘æŒ‡å—ï¼šåŸå­æ›´æ–°

åœ¨æ¶‰åŠé‡‘é¢ã€åº“å­˜ç­‰æ•°å€¼æ‰£å‡æ—¶ï¼Œ**ç»å¯¹ç¦æ­¢**ä½¿ç”¨â€œå…ˆè¯»åæ”¹â€çš„å†…å­˜è®¡ç®—æ–¹å¼ã€‚

### ğŸš« é”™è¯¯å†™æ³• (éåŸå­æ€§)
```go
// é£é™©ï¼šå¹¶å‘æ—¶ä¼šå¯¼è‡´â€œæ›´æ–°ä¸¢å¤±â€ï¼Œé’±ä¼šç®—é”™ï¼
user.Balance -= 100 
tx.Save(&user)
```

### âœ… æ­£ç¡®å†™æ³• (åŸå­æ€§)
ä½¿ç”¨ `gorm.Expr` è®©æ•°æ®åº“æ‰§è¡Œè®¡ç®—ï¼Œåˆ©ç”¨è¡Œé”ä¿è¯æ•°æ®å®‰å…¨ã€‚

```go
// å®‰å…¨ï¼šç”Ÿæˆ UPDATE users SET balance = balance - 100 WHERE ...
err := tx.Model(&user).Update("balance", gorm.Expr("balance - ?", 100)).Error
if err != nil {
    tx.Rollback()
    return
}
```

---

## 4. å®Œæ•´ä»£ç èŒƒä¾‹ (è½¬è´¦åœºæ™¯)

```go
func (con *BankController) Transfer(c *gin.Context) {
    // 1. å¼€å¯äº‹åŠ¡
    tx := model.DB.Begin()
    
    // 2. å…œåº•å›æ»š
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()

    // 3. æ‰£æ¬¾ (åŸå­æ›´æ–°)
    var u1 model.Bank
    // å…ˆç¡®è®¤ç”¨æˆ·å­˜åœ¨
    if err := tx.Where("name = ?", "å¼ ä¸‰").First(&u1).Error; err != nil {
        tx.Rollback()
        con.error(c)
        return
    }
    // æ‰§è¡Œæ‰£æ¬¾
    if err := tx.Model(&u1).Update("bank", gorm.Expr("bank - ?", 100)).Error; err != nil {
        tx.Rollback()
        con.error(c)
        return
    }

    // 4. åŠ æ¬¾ (åŸå­æ›´æ–°)
    var u2 model.Bank
    if err := tx.Where("name = ?", "æå››").First(&u2).Error; err != nil {
        tx.Rollback()
        con.error(c)
        return
    }
    if err := tx.Model(&u2).Update("bank", gorm.Expr("bank + ?", 100)).Error; err != nil {
        tx.Rollback()
        con.error(c)
        return
    }

    // 5. æäº¤äº‹åŠ¡ (è‡³å…³é‡è¦!)
    tx.Commit()

    c.JSON(200, gin.H{"message": "è½¬è´¦æˆåŠŸ"})
}
```

---

## 5. å¸¸è§é—®é¢˜æ’æŸ¥ (FAQ)

| ç°è±¡ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
| :--- | :--- | :--- |
| **æ¥å£è¿”å›æˆåŠŸä½†æ•°æ®æ²¡å˜** | å¿˜è®°å†™ `tx.Commit()` | åœ¨ return æˆåŠŸå“åº”å‰åŠ ä¸Š `tx.Commit()` |
| **æ•°æ®è¢«æ”¹ä¹±äº† (å¹¶å‘)** | ä½¿ç”¨äº†å†…å­˜è®¡ç®— (`user.Age++`) | æ”¹ç”¨ `gorm.Expr("age + ?", 1)` |
| **æ­»é” / äº‹åŠ¡ä¸é‡Šæ”¾** | å‘ç”Ÿ Panic æˆ–æå‰ Return ä½†æ²¡å›æ»š | ç¡®ä¿æœ‰ `defer rollback` æœºåˆ¶ |
| **æ“ä½œæ²¡è¿›å…¥äº‹åŠ¡** | ç”¨äº† `model.DB` è€Œä¸æ˜¯ `tx` | æ£€æŸ¥æ‰€æœ‰ DB æ“ä½œæ˜¯å¦éƒ½ä½¿ç”¨äº† `tx` å˜é‡ |
